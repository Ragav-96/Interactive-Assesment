import React, { useState, useEffect } from 'react';
import { AlertCircle, Trophy, Timer, ArrowRight, Key, DoorOpen } from 'lucide-react';

const AccentureGamePractice = () => {
  const [currentGame, setCurrentGame] = useState(null);
  const [score, setScore] = useState({ bubble: 0, path: 0, maze: 0 });

  // Game 1: Bubble Math Game
  const BubbleGame = () => {
    const [questions, setQuestions] = useState([]);
    const [currentQ, setCurrentQ] = useState(0);
    const [selectedBubbles, setSelectedBubbles] = useState([]);
    const [timeLeft, setTimeLeft] = useState(15);
    const [result, setResult] = useState(null);
    const [gameOver, setGameOver] = useState(false);
    const [totalScore, setTotalScore] = useState(0);

    const generateQuestion = () => {
      const operators = ['+', '-', '*', '/'];
      const bubbles = [];
      for (let i = 0; i < 3; i++) {
        const num1 = Math.floor(Math.random() * 20) + 1;
        const num2 = Math.floor(Math.random() * 10) + 1;
        const op = operators[Math.floor(Math.random() * operators.length)];
        let expression = `${num1} ${op} ${num2}`;
        let value = 0;
        
        switch(op) {
          case '+': value = num1 + num2; break;
          case '-': value = num1 - num2; break;
          case '*': value = num1 * num2; break;
          case '/': value = Math.floor(num1 / num2); break;
        }
        
        bubbles.push({ expression, value, id: i });
      }
      return bubbles;
    };

    useEffect(() => {
      const qs = Array(25).fill(0).map(() => generateQuestion());
      setQuestions(qs);
    }, []);

    useEffect(() => {
      if (timeLeft > 0 && !result && !gameOver) {
        const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
        return () => clearTimeout(timer);
      } else if (timeLeft === 0 && !result) {
        checkAnswer();
      }
    }, [timeLeft, result, gameOver]);

    const handleBubbleClick = (bubble) => {
      if (selectedBubbles.length < 3 && !selectedBubbles.find(b => b.id === bubble.id)) {
        setSelectedBubbles([...selectedBubbles, bubble]);
        if (selectedBubbles.length === 2) {
          setTimeout(() => checkAnswer([...selectedBubbles, bubble]), 500);
        }
      }
    };

    const checkAnswer = (selected = selectedBubbles) => {
      const correctOrder = [...questions[currentQ]].sort((a, b) => a.value - b.value);
      const isCorrect = selected.every((bubble, idx) => bubble.value === correctOrder[idx].value);
      
      setResult(isCorrect);
      if (isCorrect) setTotalScore(totalScore + 1);
      
      setTimeout(() => {
        if (currentQ < 24) {
          setCurrentQ(currentQ + 1);
          setSelectedBubbles([]);
          setTimeLeft(15);
          setResult(null);
        } else {
          setGameOver(true);
          setScore(prev => ({ ...prev, bubble: totalScore + (isCorrect ? 1 : 0) }));
        }
      }, 1500);
    };

    if (questions.length === 0) return <div className="text-center p-8">Loading...</div>;
    if (gameOver) {
      return (
        <div className="text-center p-8">
          <Trophy className="w-16 h-16 mx-auto mb-4 text-yellow-500" />
          <h2 className="text-2xl font-bold mb-2">Bubble Game Complete!</h2>
          <p className="text-xl">Score: {totalScore}/25</p>
          <button onClick={() => setCurrentGame(null)} className="mt-4 px-6 py-2 bg-blue-600 text-white rounded">
            Back to Menu
          </button>
        </div>
      );
    }

    const currentBubbles = questions[currentQ];

    return (
      <div className="max-w-4xl mx-auto p-6">
        <div className="bg-blue-50 p-4 rounded-lg mb-6">
          <div className="flex justify-between items-center mb-2">
            <span className="text-lg font-semibold">Question {currentQ + 1}/25</span>
            <span className={`text-2xl font-bold ${timeLeft <= 5 ? 'text-red-500' : 'text-blue-600'}`}>
              <Timer className="inline w-6 h-6" /> {timeLeft}s
            </span>
          </div>
          <p className="text-sm text-gray-600">Click bubbles from LOWEST to HIGHEST value</p>
        </div>

        {result !== null && (
          <div className={`p-4 rounded mb-4 ${result ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
            {result ? '‚úì Correct!' : '‚úó Wrong!'}
          </div>
        )}

        <div className="grid grid-cols-3 gap-8 mb-6">
          {currentBubbles.map((bubble, idx) => (
            <div key={idx} className="flex flex-col items-center">
              <button
                onClick={() => handleBubbleClick(bubble)}
                disabled={result !== null}
                className={`w-32 h-32 rounded-full flex items-center justify-center text-xl font-bold transition-all
                  ${selectedBubbles.find(b => b.id === bubble.id) 
                    ? 'bg-blue-600 text-white scale-110' 
                    : 'bg-gradient-to-br from-pink-400 to-purple-500 text-white hover:scale-105'
                  }
                  ${result !== null ? 'cursor-not-allowed opacity-50' : 'cursor-pointer'}
                `}
              >
                {bubble.expression}
              </button>
              {selectedBubbles.find(b => b.id === bubble.id) && (
                <div className="mt-2 text-lg font-bold text-blue-600">
                  {selectedBubbles.findIndex(b => b.id === bubble.id) + 1}
                </div>
              )}
            </div>
          ))}
        </div>

        <div className="text-center text-gray-600">
          Selected: {selectedBubbles.length}/3
        </div>
      </div>
    );
  };

  // Game 2: Path Finding Puzzle
  const PathGame = () => {
    const [grid, setGrid] = useState([]);
    const [questionNum, setQuestionNum] = useState(1);
    const [timeLeft, setTimeLeft] = useState(300);
    const [message, setMessage] = useState('');

    const initializeGrid = () => {
      const newGrid = Array(3).fill(0).map(() => 
        Array(3).fill(0).map(() => ({
          arrows: ['‚Üí', '‚Üì'],
          rotation: 0
        }))
      );
      setGrid(newGrid);
    };

    useEffect(() => {
      initializeGrid();
    }, []);

    useEffect(() => {
      if (timeLeft > 0) {
        const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
        return () => clearTimeout(timer);
      }
    }, [timeLeft]);

    const rotateCell = (row, col) => {
      const newGrid = [...grid];
      const cell = newGrid[row][col];
      cell.rotation = (cell.rotation + 90) % 360;
      setGrid(newGrid);
    };

    const changeArrowDirection = (row, col) => {
      const newGrid = [...grid];
      const cell = newGrid[row][col];
      const directions = [
        ['‚Üí', '‚Üì'],
        ['‚Üê', '‚Üí'],
        ['‚Üë', '‚Üì'],
        ['‚Üë', '‚Üê']
      ];
      const currentIdx = directions.findIndex(d => 
        JSON.stringify(d) === JSON.stringify(cell.arrows)
      );
      cell.arrows = directions[(currentIdx + 1) % directions.length];
      setGrid(newGrid);
    };

    const checkPath = () => {
      setMessage('Path validated! Move to next question.');
      setTimeout(() => {
        if (questionNum < 3) {
          setQuestionNum(questionNum + 1);
          initializeGrid();
          setMessage('');
          setTimeLeft(300);
        } else {
          setScore(prev => ({ ...prev, path: 3 }));
          setCurrentGame(null);
        }
      }, 2000);
    };

    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;

    return (
      <div className="max-w-4xl mx-auto p-6">
        <div className="bg-purple-50 p-4 rounded-lg mb-6">
          <div className="flex justify-between items-center mb-2">
            <span className="text-lg font-semibold">Path Finding - Question {questionNum}/3</span>
            <span className="text-xl font-bold text-purple-600">
              <Timer className="inline w-5 h-5" /> {minutes}:{seconds.toString().padStart(2, '0')}
            </span>
          </div>
          <p className="text-sm text-gray-600">Create a path from START (üöÄ) to END (üéØ)</p>
        </div>

        {message && (
          <div className="bg-green-100 text-green-800 p-3 rounded mb-4">
            {message}
          </div>
        )}

        <div className="grid grid-cols-3 gap-2 mb-6 max-w-md mx-auto">
          {grid.map((row, rIdx) => (
            row.map((cell, cIdx) => (
              <div key={`${rIdx}-${cIdx}`} className="relative">
                <div className="bg-white border-2 border-gray-300 rounded-lg p-4 h-24 flex items-center justify-center text-2xl">
                  {rIdx === 0 && cIdx === 0 ? 'üöÄ' : 
                   rIdx === 2 && cIdx === 2 ? 'üéØ' :
                   <div style={{ transform: `rotate(${cell.rotation}deg)` }}>
                     {cell.arrows.map((arrow, i) => (
                       <span key={i} className="mx-1">{arrow}</span>
                     ))}
                   </div>
                  }
                </div>
                {!(rIdx === 0 && cIdx === 0) && !(rIdx === 2 && cIdx === 2) && (
                  <div className="absolute -bottom-8 left-0 right-0 flex gap-1 justify-center">
                    <button
                      onClick={() => rotateCell(rIdx, cIdx)}
                      className="text-xs bg-blue-500 text-white px-2 py-1 rounded"
                    >
                      ‚Üª
                    </button>
                    <button
                      onClick={() => changeArrowDirection(rIdx, cIdx)}
                      className="text-xs bg-green-500 text-white px-2 py-1 rounded"
                    >
                      ‚áÑ
                    </button>
                  </div>
                )}
              </div>
            ))
          ))}
        </div>

        <div className="text-center mt-12">
          <button
            onClick={checkPath}
            className="px-8 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700"
          >
            ‚úì Check Path
          </button>
        </div>

        <div className="mt-6 p-4 bg-gray-50 rounded">
          <h4 className="font-semibold mb-2">Controls:</h4>
          <p className="text-sm">‚Üª Rotate Tile - Rotates tile clockwise</p>
          <p className="text-sm">‚áÑ Change Arrows - Changes arrow directions</p>
        </div>
      </div>
    );
  };

  // Game 3: Door and Key Maze
  const MazeGame = () => {
    const [position, setPosition] = useState({ row: 0, col: 0 });
    const [keyPos] = useState({ row: 1, col: 1 });
    const [doorPos] = useState({ row: 2, col: 2 });
    const [hasKey, setHasKey] = useState(false);
    const [walls, setWalls] = useState(new Set());
    const [revealedWalls, setRevealedWalls] = useState(new Set());
    const [moves, setMoves] = useState(0);
    const [message, setMessage] = useState('');
    const [questionNum, setQuestionNum] = useState(1);

    useEffect(() => {
      const wallSet = new Set();
      for (let i = 0; i < 3; i++) {
        const r = Math.floor(Math.random() * 3);
        const c = Math.floor(Math.random() * 3);
        if (!(r === 0 && c === 0) && !(r === keyPos.row && c === keyPos.col) && 
            !(r === doorPos.row && c === doorPos.col)) {
          wallSet.add(`${r}-${c}`);
        }
      }
      setWalls(wallSet);
    }, [questionNum]);

    const move = (direction) => {
      let newRow = position.row;
      let newCol = position.col;

      switch(direction) {
        case 'up': newRow--; break;
        case 'down': newRow++; break;
        case 'left': newCol--; break;
        case 'right': newCol++; break;
      }

      if (newRow < 0 || newRow > 2 || newCol < 0 || newCol > 2) {
        setMessage('Cannot move outside grid!');
        return;
      }

      const newPosKey = `${newRow}-${newCol}`;
      
      if (walls.has(newPosKey)) {
        setRevealedWalls(prev => new Set([...prev, newPosKey]));
        setMessage('Wall detected! Try another direction.');
        return;
      }

      setPosition({ row: newRow, col: newCol });
      setMoves(moves + 1);
      setMessage('');

      if (newRow === keyPos.row && newCol === keyPos.col && !hasKey) {
        setHasKey(true);
        setMessage('Key collected! Now find the door!');
      }

      if (newRow === doorPos.row && newCol === doorPos.col && hasKey) {
        setMessage('Success! Maze completed!');
        setTimeout(() => {
          if (questionNum < 3) {
            setQuestionNum(questionNum + 1);
            setPosition({ row: 0, col: 0 });
            setHasKey(false);
            setRevealedWalls(new Set());
            setMoves(0);
            setMessage('');
          } else {
            setScore(prev => ({ ...prev, maze: 3 }));
            setCurrentGame(null);
          }
        }, 2000);
      }
    };

    return (
      <div className="max-w-4xl mx-auto p-6">
        <div className="bg-green-50 p-4 rounded-lg mb-6">
          <div className="flex justify-between items-center mb-2">
            <span className="text-lg font-semibold">Door & Key Maze - Question {questionNum}/3</span>
            <span className="text-lg">Moves: {moves}</span>
          </div>
          <p className="text-sm text-gray-600 flex items-center gap-2">
            <Key className="w-4 h-4" /> Collect key ‚Üí <DoorOpen className="w-4 h-4" /> Open door
          </p>
          {hasKey && <p className="text-sm font-bold text-green-600 mt-1">‚úì Key Collected!</p>}
        </div>

        {message && (
          <div className={`p-3 rounded mb-4 ${
            message.includes('Success') ? 'bg-green-100 text-green-800' :
            message.includes('Wall') ? 'bg-red-100 text-red-800' :
            'bg-blue-100 text-blue-800'
          }`}>
            {message}
          </div>
        )}

        <div className="grid grid-cols-3 gap-2 mb-6 max-w-sm mx-auto">
          {Array(3).fill(0).map((_, rIdx) => (
            Array(3).fill(0).map((_, cIdx) => {
              const isPlayer = position.row === rIdx && position.col === cIdx;
              const isKey = keyPos.row === rIdx && keyPos.col === cIdx && !hasKey;
              const isDoor = doorPos.row === rIdx && doorPos.col === cIdx;
              const isWall = revealedWalls.has(`${rIdx}-${cIdx}`);

              return (
                <div
                  key={`${rIdx}-${cIdx}`}
                  className={`h-24 flex items-center justify-center text-3xl border-2 rounded-lg
                    ${isWall ? 'bg-gray-800 border-gray-900' : 'bg-white border-gray-300'}
                  `}
                >
                  {isPlayer && (hasKey ? 'üßëüîë' : 'üßë')}
                  {isKey && 'üîë'}
                  {isDoor && 'üö™'}
                  {isWall && 'üß±'}
                </div>
              );
            })
          ))}
        </div>

        <div className="flex justify-center gap-2 mb-4">
          <div className="flex flex-col items-center">
            <button
              onClick={() => move('up')}
              className="px-6 py-3 bg-blue-500 text-white rounded font-bold hover:bg-blue-600 mb-2"
            >
              ‚Üë
            </button>
            <div className="flex gap-2">
              <button
                onClick={() => move('left')}
                className="px-6 py-3 bg-blue-500 text-white rounded font-bold hover:bg-blue-600"
              >
                ‚Üê
              </button>
              <button
                onClick={() => move('down')}
                className="px-6 py-3 bg-blue-500 text-white rounded font-bold hover:bg-blue-600"
              >
                ‚Üì
              </button>
              <button
                onClick={() => move('right')}
                className="px-6 py-3 bg-blue-500 text-white rounded font-bold hover:bg-blue-600"
              >
                ‚Üí
              </button>
            </div>
          </div>
        </div>

        <div className="p-4 bg-gray-50 rounded">
          <h4 className="font-semibold mb-2">Remember:</h4>
          <p className="text-sm">‚Ä¢ Walls are invisible until you hit them</p>
          <p className="text-sm">‚Ä¢ You can revisit the same cells</p>
          <p className="text-sm">‚Ä¢ Collect key first, then reach door</p>
          <p className="text-sm">‚Ä¢ Try to complete in least moves possible</p>
        </div>
      </div>
    );
  };

  // Main Menu
  if (!currentGame) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-8">
        <div className="max-w-4xl mx-auto">
          <h1 className="text-4xl font-bold text-center mb-2 text-gray-800">
            Accenture Game-Based Aptitude Practice
          </h1>
          <p className="text-center text-gray-600 mb-8">Practice all three sections</p>

          <div className="grid md:grid-cols-3 gap-6 mb-8">
            <button
              onClick={() => setCurrentGame('bubble')}
              className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all hover:scale-105"
            >
              <div className="text-5xl mb-3 text-center">üéà</div>
              <h3 className="text-xl font-bold mb-2 text-center">Bubble Game</h3>
              <p className="text-sm text-gray-600 mb-3 text-center">Quick Math Challenge</p>
              <ul className="text-xs text-gray-600 space-y-1">
                <li>‚Ä¢ 25 questions</li>
                <li>‚Ä¢ 15 seconds each</li>
                <li>‚Ä¢ Order bubbles lowest to highest</li>
                <li>‚Ä¢ Score: {score.bubble}/25</li>
              </ul>
            </button>

            <button
              onClick={() => setCurrentGame('path')}
              className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all hover:scale-105"
            >
              <div className="text-5xl mb-3 text-center">üöÄ</div>
              <h3 className="text-xl font-bold mb-2 text-center">Path Finding</h3>
              <p className="text-sm text-gray-600 mb-3 text-center">Rocket Puzzle</p>
              <ul className="text-xs text-gray-600 space-y-1">
                <li>‚Ä¢ 3 questions</li>
                <li>‚Ä¢ 4-5 minutes each</li>
                <li>‚Ä¢ Create path with arrows</li>
                <li>‚Ä¢ Score: {score.path}/3</li>
              </ul>
            </button>

            <button
              onClick={() => setCurrentGame('maze')}
              className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all hover:scale-105"
            >
              <div className="text-5xl mb-3 text-center">üîë</div>
              <h3 className="text-xl font-bold mb-2 text-center">Door & Key</h3>
              <p className="text-sm text-gray-600 mb-3 text-center">Maze Puzzle</p>
              <ul className="text-xs text-gray-600 space-y-1">
                <li>‚Ä¢ 3 questions</li>
                <li>‚Ä¢ Hidden walls</li>
                <li>‚Ä¢ Collect key ‚Üí Open door</li>
                <li>‚Ä¢ Score: {score.maze}/3</li>
              </ul>
            </button>
          </div>

          <div className="bg-white p-6 rounded-xl shadow-lg">
            <h3 className="text-lg font-bold mb-3 flex items-center gap-2">
              <AlertCircle className="w-5 h-5" />
              Important Tips
            </h3>
            <div className="grid md:grid-cols-3 gap-4 text-sm">
              <div>
                <h4 className="font-semibold mb-1">Bubble Game:</h4>
                <p className="text-gray-600">Calculate mentally fast. Scan for obvious smallest/largest first.</p>
              </div>
              <div>
                <h4 className="font-semibold mb-1">Path Finding:</h4>
                <p className="text-gray-600">Create the path first, then adjust arrow directions.</p>
              </div>
              <div>
                <h4 className="font-semibold mb-1">Door & Key:</h4>
                <p className="text-gray-600">Remember wall locations. You can revisit cells.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
      <button
        onClick={() => setCurrentGame(null)}
        className="mb-4 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
      >
        ‚Üê Back to Menu
      </button>
      {currentGame === 'bubble' && <BubbleGame />}
      {currentGame === 'path' && <PathGame />}
      {currentGame === 'maze' && <MazeGame />}
    </div>
  );
};

export default AccentureGamePractice;